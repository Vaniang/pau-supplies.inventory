<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplies Monitoring System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS STYLING --- */
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #3498db; --bg: #f4f6f8; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: #333; }

        /* Sidebar & Layout */
        .sidebar { width: 250px; background: var(--primary); color: var(--white); display: flex; flex-direction: column; padding: 20px; }
        .sidebar h2 { text-align: center; border-bottom: 1px solid #ffffff33; padding-bottom: 10px; }
        .nav-link { padding: 15px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background: var(--accent); }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Dashboard & Tables */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card .number { font-size: 2.5rem; font-weight: bold; color: var(--primary); }
        
        table.inventory-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        table.inventory-table th, table.inventory-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        table.inventory-table th { background: var(--secondary); color: white; }
        
        .btn-req { position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: white; padding: 15px 30px; border-radius: 50px; border: none; font-size: 1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10; }

        /* --- MODAL STYLING --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: none; justify-content: center; overflow-y: auto; 
            z-index: 2000; padding-top: 20px; padding-bottom: 20px;
        }
        .modal-overlay.open { display: flex; }

        /* FIXED BUTTONS */
        .modal-actions { 
            position: fixed; top: 20px; right: 20px; 
            display: flex; flex-direction: column; gap: 10px; 
            z-index: 3000; background: white; padding: 10px; 
            border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; width: 150px;}
        .btn-close { background: #e74c3c; }
        .btn-print { background: #27ae60; }
        .btn-excel { background: #217346; }
        .btn-submit { background: #2980b9; }

        /* The Paper Slip (A4 Container) */
        .paper-slip {
            width: 210mm; 
            min-height: 297mm; 
            background: white;
            padding: 5mm 10mm; /* Smaller padding to fit two copies */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            font-family: 'Arial Narrow', Arial, sans-serif;
            color: black;
            font-size: 10px; /* Slightly smaller font to fit 2 copies */
            box-sizing: border-box;
            position: relative;
        }

        /* --- OFFICIAL RIS FORM CSS --- */
        .ris-container { margin-bottom: 10px; }
        .cut-line { border-top: 1px dashed black; margin: 15px 0; position: relative; }
        .cut-line::after { content: "✂"; position: absolute; right: 50%; top: -10px; background: white; padding: 0 5px; font-size: 14px;}

        .ris-header-italic { text-align: right; font-style: italic; font-size: 9px; margin-bottom: 2px; font-weight: bold; }
        .ris-title { text-align: center; font-weight: bold; font-size: 14px; margin: 5px 0 10px 0; }
        
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        .info-table td { padding: 1px; vertical-align: bottom; }
        .label { font-weight: bold; white-space: nowrap; font-size: 10px; }
        .input-line { border-bottom: 1px solid black; text-align: center; font-weight: bold; display: block; width: 100%; min-height: 14px;}

        table.ris-table { width: 100%; border-collapse: collapse; border: 2px solid black; table-layout: fixed; }
        table.ris-table th, table.ris-table td { border: 1px solid black; padding: 2px; text-align: center; vertical-align: middle; word-wrap: break-word; font-size: 10px; }
        table.ris-table th { font-weight: bold; background: #eee; }
        .empty-row td { height: 14px; }

        table.footer-table { width: 100%; border-collapse: collapse; border: 2px solid black; border-top: none; table-layout: fixed; margin-top: -2px;}
        table.footer-table td { border-right: 1px solid black; padding: 2px; vertical-align: top; font-size: 10px; }
        table.footer-table tr:first-child td { border-bottom: none; font-weight: bold; }
        table.footer-table tr td:first-child { width: 100px; font-weight: bold; text-align: left;}
        
        .sig-name { text-align: center; font-weight: bold; text-transform: uppercase; margin-top: 10px; font-size: 11px;}
        .sig-title { text-align: center; font-size: 9px; }

        /* Add Item Controls */
        .add-item-controls {
            background: #eee; padding: 15px; border-radius: 5px;
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 2100;
            display: flex; gap: 10px; align-items: center;
        }

        /* --- PRINT SETTINGS --- */
       /* --- PRINT SETTINGS --- */
@media print {
    @page { 
        margin: 0; /* This removes the header (date/title) and footer (url) */
    }
    body { 
        margin: 0; 
        padding: 0;
        -webkit-print-color-adjust: exact; 
    }
    body * { visibility: hidden; }
    
    .modal-overlay { 
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: white; 
        display: block !important; 
        padding: 0; 
        overflow: visible; 
        z-index: 9999;
    }

    /* Target the slip specifically */
    .paper-slip, .paper-slip * { visibility: visible; }
    
    .paper-slip { 
        transform: scale(1); 
        width: 100%; 
        margin: 0; 
        padding: 10mm; /* Add padding here since we removed page margins */
        position: absolute; 
        top: 0; 
        left: 0; 
        box-shadow: none; 
    }
    
    /* Hide buttons and controls */
    .modal-actions, .add-item-controls { display: none !important; }
}
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>IMS System</h2>
        <div class="nav-link active" onclick="nav('dashboard', this)">Dashboard</div>
        <div class="nav-link" onclick="nav('inventory', this)">Inventory List</div>
    </div>

    <div class="main">
        <div id="dashboard" class="section active">
            <h1>Dashboard</h1>
            <div class="cards-grid">
                <div class="card"><h3>Total Stock</h3><div class="number" id="dash-total-items">0</div></div>
                <div class="card"><h3>Requisitions</h3><div class="number" id="dash-total-reqs">0</div></div>
            </div>
            <div style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 8px;">
                <h3>Upload List (Excel)</h3>
                <input type="file" onchange="handleFileUpload(this)" accept=".xlsx, .csv" />
                <p style="color:red; font-size:12px;">Format: Name, Qty, Price</p>
            </div>
            <div style="margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px;">
    <h3>Admin Controls</h3>
    <button onclick="resetInventory()" style="background: #c0392b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
        ⚠ Reset All Stock to Initial Count
    </button>
</div>
            <div style="background:white; padding:20px; border-radius:8px;"><canvas id="stockChart"></canvas></div>
        </div>

        <div id="inventory" class="section">
            <h1>Inventory List</h1>
            <table class="inventory-table">
                <thead><tr><th>Item Name</th><th>Init Qty</th><th>Unit Price</th><th>History</th><th>Left</th></tr></thead>
                <tbody id="inventoryTable"></tbody>
            </table>
            <button class="btn-req" onclick="openModal()">+ Request Supplies</button>
        </div>
    </div>

    <div class="modal-overlay" id="reqModal">
        
        <div class="modal-actions">
            <button class="btn btn-close" onclick="closeModal()">Close</button>
            <button class="btn btn-print" onclick="window.print()">Print RIS</button>
            <button class="btn btn-excel" onclick="exportToExcel()">Download Excel</button>
            <button class="btn btn-submit" onclick="submitRequisition()">Submit & Save</button>
        </div>

        <div class="add-item-controls">
            <b>Add Item:</b>
            <select id="itemSelect" style="padding:5px;"><option value="">Select Item...</option></select>
            <input type="number" id="itemQty" placeholder="Qty" style="width:60px; padding:5px;">
            <button class="btn" style="background:#27ae60; padding:5px 10px; width:auto;" onclick="addItemToSlip()">Add</button>
        </div>

        <div class="paper-slip" id="printableArea">
            
            <div class="ris-container">
                <div class="ris-header-italic">Appendix 63</div>
                <div class="ris-title">REQUISITION AND ISSUE SLIP</div>
                <table class="info-table">
                    <tr><td width="10%" class="label">Entity Name:</td><td width="40%" class="input-line">DepED RO I</td><td width="20%"></td><td width="10%" class="label">Fund Cluster:</td><td width="20%" class="input-line">01</td></tr>
                    <tr><td class="label">Division:</td><td class="input-line">ORD-PUBLIC AFFAIRS UNIT</td><td></td><td class="label" colspan="2" style="font-size:9px;">Responsibility Center Code:</td></tr>
                    <tr><td class="label">Office:</td><td class="input-line"></td><td></td><td class="label">RIS No.:</td><td class="input-line" id="risNo_1"></td></tr>
                </table>
                <table class="ris-table">
                    <thead>
                        <tr><th colspan="4">Requisition</th><th colspan="2">Stock Available?</th><th colspan="2">Issue</th></tr>
                        <tr><th width="8%">Stock No.</th><th width="8%">Unit</th><th width="34%">Description</th><th width="10%">Quantity</th><th width="5%">Yes</th><th width="5%">No</th><th width="10%">Quantity</th><th width="20%">Remarks</th></tr>
                    </thead>
                    <tbody id="risTableBody_1"></tbody>
                </table>
                <table class="footer-table">
                    <tr><td></td><td>Requested by:</td><td>Approved by:</td><td>Issued by:</td><td style="border-right:none;">Received by:</td></tr>
                    <tr><td>Signature:</td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black; border-right:none;"></td></tr>
                    <tr><td>Printed Name:</td><td><div class="sig-name">JOVANIE M. MAZON</div></td><td><div class="sig-name">CESAR S. BUCSIT</div></td><td></td><td style="border-right:none;"></td></tr>
                    <tr><td>Designation:</td><td><div class="sig-title">Admin Assistant I</div><div class="sig-title">ORD-PAU</div></td><td><div class="sig-title">Admin Officer V</div><div class="sig-title">ORD-PAU Caretaker</div></td><td></td><td style="border-right:none;"></td></tr>
                    <tr><td>Date:</td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black; border-right:none;"></td></tr>
                </table>
            </div>

            <div class="cut-line"></div>

            <div class="ris-container">
                <div class="ris-header-italic">Appendix 63</div>
                <div class="ris-title">REQUISITION AND ISSUE SLIP</div>
                <table class="info-table">
                    <tr><td width="10%" class="label">Entity Name:</td><td width="40%" class="input-line">DepED RO I</td><td width="20%"></td><td width="10%" class="label">Fund Cluster:</td><td width="20%" class="input-line">01</td></tr>
                    <tr><td class="label">Division:</td><td class="input-line">ORD-PUBLIC AFFAIRS UNIT</td><td></td><td class="label" colspan="2" style="font-size:9px;">Responsibility Center Code:</td></tr>
                    <tr><td class="label">Office:</td><td class="input-line"></td><td></td><td class="label">RIS No.:</td><td class="input-line" id="risNo_2"></td></tr>
                </table>
                <table class="ris-table">
                    <thead>
                        <tr><th colspan="4">Requisition</th><th colspan="2">Stock Available?</th><th colspan="2">Issue</th></tr>
                        <tr><th width="8%">Stock No.</th><th width="8%">Unit</th><th width="34%">Description</th><th width="10%">Quantity</th><th width="5%">Yes</th><th width="5%">No</th><th width="10%">Quantity</th><th width="20%">Remarks</th></tr>
                    </thead>
                    <tbody id="risTableBody_2"></tbody>
                </table>
                <table class="footer-table">
                    <tr><td></td><td>Requested by:</td><td>Approved by:</td><td>Issued by:</td><td style="border-right:none;">Received by:</td></tr>
                    <tr><td>Signature:</td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black; border-right:none;"></td></tr>
                    <tr><td>Printed Name:</td><td><div class="sig-name">JOVANIE M. MAZON</div></td><td><div class="sig-name">CESAR S. BUCSIT</div></td><td></td><td style="border-right:none;"></td></tr>
                    <tr><td>Designation:</td><td><div class="sig-title">Admin Assistant I</div><div class="sig-title">ORD-PAU</div></td><td><div class="sig-title">Admin Officer V</div><div class="sig-title">ORD-PAU Caretaker</div></td><td></td><td style="border-right:none;"></td></tr>
                    <tr><td>Date:</td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black; border-right:none;"></td></tr>
                </table>
            </div>

        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDxPnmXxfno19bkj9VHP1Do97PDg0lp04s",
            authDomain: "supplies-monitoring.firebaseapp.com",
            projectId: "supplies-monitoring",
            storageBucket: "supplies-monitoring.firebasestorage.app",
            messagingSenderId: "524755577094",
            appId: "1:524755577094:web:cd3c45819698c3380a1687",
            measurementId: "G-033SS1BHK1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let inventoryData = [], slipItems = [];

        window.onload = () => { loadInventory(); loadStats(); };

        function nav(id, btn) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }

        function loadInventory() {
            db.collection('inventory').onSnapshot(snap => {
                inventoryData = [];
                let totalStock = 0;
                const tbody = document.getElementById('inventoryTable');
                const select = document.getElementById('itemSelect');
                tbody.innerHTML = ''; select.innerHTML = '<option value="">Select Item...</option>';

                snap.forEach(doc => {
                    const d = doc.data(); d.id = doc.id;
                    inventoryData.push(d);
                    totalStock += d.currentQty;
                });
                
                inventoryData.sort((a,b) => a.itemName.localeCompare(b.itemName));

                inventoryData.forEach(item => {
                    let dates = item.requestDates ? item.requestDates.map(d=>new Date(d).toLocaleDateString()).join(', ') : '-';
                    tbody.innerHTML += `<tr><td>${item.itemName}</td><td>${item.initialQty}</td><td>${item.unitPrice}</td><td>${dates}</td><td style="font-weight:bold;">${item.currentQty}</td></tr>`;
                    select.innerHTML += `<option value="${item.id}">${item.itemName} (Stock: ${item.currentQty})</option>`;
                });
                document.getElementById('dash-total-items').innerText = totalStock;
                updateChart();
            });
        }
        
        function loadStats() { db.collection('requisitions').onSnapshot(s => document.getElementById('dash-total-reqs').innerText = s.size); }

        function updateChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const data = inventoryData.slice(0, 15);
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: data.map(i=>i.itemName), datasets: [{ label:'Stock', data: data.map(i=>i.currentQty), backgroundColor:'#3498db' }] }
            });
        }

        function handleFileUpload(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const batch = db.batch();
                let count = 0;
                json.forEach(row => {
                    if(row.Name && row.Qty) {
                        count++;
                        batch.set(db.collection('inventory').doc(), {
                            itemName: String(row.Name), initialQty: Number(row.Qty), currentQty: Number(row.Qty), unitPrice: Number(row.Price||0), requestDates: []
                        });
                    }
                });
                batch.commit().then(()=>alert(count + ' Items Imported!'));
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function openModal() { 
    document.getElementById('reqModal').classList.add('open'); 
    
    // CHANGED: We now set these to empty strings instead of generating a random number
    document.getElementById('risNo_1').innerText = '';
    document.getElementById('risNo_2').innerText = '';
    
    slipItems=[]; 
    renderSlip(); 
}
        function closeModal() { document.getElementById('reqModal').classList.remove('open'); }

        function addItemToSlip() {
            const id = document.getElementById('itemSelect').value;
            const qty = Number(document.getElementById('itemQty').value);
            if(!id || qty<=0) return;
            const item = inventoryData.find(i=>i.id===id);
            if(qty > item.currentQty) return alert('Not enough stock!');
            slipItems.push({ ...item, reqQty: qty });
            renderSlip();
        }

       function renderSlip() {
    ['risTableBody_1', 'risTableBody_2'].forEach(tableId => {
        const tbody = document.getElementById(tableId);
        tbody.innerHTML = '';
        
        slipItems.forEach((item, i) => {
            // CHANGED: Split by comma (,) AND semicolon (;) then take the first part
            // "AIR FRESHENER, aerosol..." -> "AIR FRESHENER"
            let cleanName = item.itemName.split(',')[0].split(';')[0].trim();

            tbody.innerHTML += `
                <tr>
                    <td></td> 
                    
                    <td>pc</td>
                    <td style="text-align:left">${cleanName}</td>
                    <td>${item.reqQty}</td>
                    
                    <td></td><td></td>
                    <td></td><td></td>
                </tr>`;
        });
        
        // Fill empty rows
        for(let i=0; i < (10 - slipItems.length); i++) {
            tbody.innerHTML += `<tr class="empty-row"><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
        }
    });
}

     function exportToExcel() {
    let data = [];
    for(let k=0; k<2; k++) {
        data.push(["", "", "", "", "", "", "Appendix 63"]);
        data.push(["REQUISITION AND ISSUE SLIP"]);
        data.push(["Entity Name :", "", "DepED RO I", "", "", "", "Fund Cluster :", "01"]);
        data.push(["Division :", "ORD-PAU", "", "", "", "Responsibility Center Code :", ""]);
        data.push(["Office :", "", "", "", "", "RIS No. :", ""]); 
        data.push(["Requisition", "", "", "", "Stock Available?", "", "Issue", ""]);
        data.push(["Stock No.", "Unit", "Description", "Quantity", "Yes", "No", "Quantity", "Remarks"]);
        
        slipItems.forEach((item) => {
            // CHANGED: Clean name using comma split
            let cleanName = item.itemName.split(',')[0].split(';')[0].trim();
            
            // CHANGED: First item in array is now "" (Empty Stock No)
            data.push(["", "pc", cleanName, item.reqQty, "", "", "", ""]);
        });

        for(let i=0; i < (10 - slipItems.length); i++) data.push(["", "", "", "", "", "", "", ""]);
        
        data.push(["Purpose: Office Use"]);
        data.push(["", "Requested by:", "Approved by:", "Issued by:", "", "Received by:", ""]);
        data.push(["Signature:", "", "", "", "", "", ""]);
        data.push(["Printed Name:", "JOVANIE M. MAZON", "CESAR S. BUCSIT", "", "", "", ""]);
        data.push(["Designation:", "Admin Assistant I", "Admin Officer V", "", "", "", ""]);
        data.push(["Date:", "", "", "", "", "", ""]);
        data.push(["", "", "", "", "", "", "", ""]); 
    }
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "RIS_Double");
    XLSX.writeFile(wb, "Requisition_Issue_Slip_Double.xlsx");
}
        async function submitRequisition() {
            if(!slipItems.length) return alert("No items!");
            const batch = db.batch();
            const today = new Date().toISOString();
            batch.set(db.collection('requisitions').doc(), { date: today, items: slipItems });
            slipItems.forEach(item => {
                const ref = db.collection('inventory').doc(item.id);
                const current = inventoryData.find(i=>i.id===item.id).currentQty;
                batch.update(ref, { currentQty: current - item.reqQty, requestDates: firebase.firestore.FieldValue.arrayUnion(today) });
            });
            await batch.commit();
            alert("Inventory Updated!");
            closeModal();
        }

       // --- NEW RESET FUNCTION (Resets Stock AND Deletes Req History) ---
        async function resetInventory() {
            if(!confirm("⚠ WARNING: This will reset ALL items back to their Initial Quantity AND DELETE all Requisition history (setting the count to 0).\n\nAre you sure you want to proceed?")) return;
            
            const batch = db.batch();

            // 1. Reset Inventory Stock
            inventoryData.forEach(item => {
                const ref = db.collection('inventory').doc(item.id);
                batch.update(ref, { currentQty: item.initialQty, requestDates: [] });
            });

            // 2. Delete All Requisitions (This makes the count go to 0)
            const reqSnapshot = await db.collection('requisitions').get();
            reqSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });

            // 3. Commit Changes
            try {
                await batch.commit();
                alert("Success! Stocks restored and Requisition count reset to 0.");
            } catch (error) {
                console.error("Error resetting:", error);
                alert("Error resetting. See console.");
            }
        }
    </script>
</body>
</html>





