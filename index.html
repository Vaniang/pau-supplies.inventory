<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplies Monitoring System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS STYLING --- */
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --bg: #f4f6f8;
            --white: #ffffff;
            --text: #333;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); }

        /* Sidebar */
        .sidebar { width: 250px; background: var(--primary); color: var(--white); display: flex; flex-direction: column; padding: 20px; }
        .sidebar h2 { text-align: center; margin-bottom: 40px; border-bottom: 1px solid #ffffff33; padding-bottom: 10px; }
        .nav-link { padding: 15px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background: var(--accent); }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard Cards */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .card h3 { color: #7f8c8d; font-size: 0.9rem; margin: 0; }
        .card .number { font-size: 2.5rem; font-weight: bold; color: var(--primary); margin: 10px 0; }

        /* Charts & Upload */
        .dashboard-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .chart-box, .upload-box { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .upload-box { text-align: center; border: 2px dashed #bdc3c7; display: flex; flex-direction: column; justify-content: center; }

        /* Inventory Table */
        table.inventory-table { width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table.inventory-table th, table.inventory-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        table.inventory-table th { background: var(--secondary); color: var(--white); }
        .date-cell { font-size: 0.85rem; color: #555; max-width: 200px; word-wrap: break-word; }

        .btn-req { position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); z-index: 10; }

        /* --- MODAL (Official Requisition Slip) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-overlay.open { display: flex; }
        
        /* Simulating the A4 Paper */
        .paper-slip { 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            padding: 10mm 15mm; /* Margins based on standard form */
            box-sizing: border-box; 
            position: relative; 
            overflow-y: auto;
            transform: scale(0.85); 
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            font-family: 'Arial', sans-serif;
            color: #000;
        }

        /* Official Form Styling (Matches Image) */
        .ris-header-top { text-align: right; font-style: italic; font-size: 10px; margin-bottom: 5px; }
        .ris-title { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 15px; }
        
        .ris-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 2px solid black;
            padding-bottom: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .ris-info-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .ris-label { font-weight: bold; margin-right: 5px; }
        .ris-input { border-bottom: 1px solid #000; flex: 1; text-align: center; font-weight: bold; }

        /* The Complex Grid Table */
        table.ris-table { width: 100%; border-collapse: collapse; font-size: 11px; border: 2px solid black; }
        table.ris-table th, table.ris-table td { border: 1px solid black; padding: 4px; text-align: center; }
        table.ris-table th { font-weight: bold; }
        
        .empty-row td { height: 18px; } /* Height for blank lines */

        /* Signatures Section */
        .ris-footer { 
            width: 100%; 
            border: 2px solid black; 
            border-top: none; 
            display: flex; 
            font-size: 11px;
        }
        .sig-col { flex: 1; border-right: 1px solid black; padding: 5px; display: flex; flex-direction: column; }
        .sig-col:last-child { border-right: none; }
        .sig-label { font-weight: bold; margin-bottom: 25px; }
        .sig-name { font-weight: bold; text-align: center; text-transform: uppercase; border-bottom: 1px solid black; margin: 0 5px; }
        .sig-title { text-align: center; font-size: 10px; margin-top: 2px; }
        .sig-date { margin-top: 10px; }

        /* Controls for adding items */
        .add-item-controls { background: #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-family: sans-serif; }
        .modal-actions { position: absolute; top: 10px; right: -150px; display: flex; flex-direction: column; gap: 10px; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; }
        .btn-close { background: #e74c3c; }
        .btn-print { background: #27ae60; }
        .btn-submit { background: #2980b9; }

        /* PRINT MEDIA QUERY */
        @media print {
            body * { visibility: hidden; }
            .modal-overlay { position: absolute; top: 0; left: 0; background: white; display: block !important; padding: 0; }
            .paper-slip, .paper-slip * { visibility: visible; }
            .paper-slip { transform: scale(1); width: 100%; height: 100%; box-shadow: none; margin: 0; padding: 10mm; }
            .modal-actions, .add-item-controls { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>IMS System</h2>
        <div class="nav-link active" onclick="nav('dashboard', this)">Dashboard</div>
        <div class="nav-link" onclick="nav('inventory', this)">Inventory List</div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="section active">
            <h1>Dashboard</h1>
            <div class="cards-grid">
                <div class="card">
                    <h3>Total Items in Stock</h3>
                    <div class="number" id="dash-total-items">0</div>
                </div>
                <div class="card">
                    <h3>Total Requisitions</h3>
                    <div class="number" id="dash-total-reqs">0</div>
                </div>
            </div>
            <div class="dashboard-row">
                <div class="chart-box"><canvas id="stockChart"></canvas></div>
                <div class="upload-box">
                    <h3>Upload Supplies List</h3>
                    <input type="file" id="excelUpload" onchange="handleFileUpload(this)" accept=".xlsx, .xls, .csv" />
                    <p style="font-size:0.8rem; margin-top:10px; color: #e74c3c;">Excel Header Format: <br><b>Name, Qty, Price</b></p>
                </div>
            </div>
        </div>

        <div id="inventory" class="section">
            <h1>Inventory List</h1>
            <table class="inventory-table">
                <thead>
                    <tr><th>Item Name</th><th>Init Qty</th><th>Unit Price</th><th>Date Requested</th><th>Items Left</th></tr>
                </thead>
                <tbody id="inventoryTable"></tbody>
            </table>
            <button class="btn-req" onclick="openModal()">+ Request Supplies</button>
        </div>

    </div>

    <div class="modal-overlay" id="reqModal">
        
        <div class="paper-slip">
            
            <div class="modal-actions">
                <button class="btn btn-print" onclick="window.print()">Print Slip</button>
                <button class="btn btn-submit" onclick="submitRequisition()">Submit</button>
                <button class="btn btn-close" onclick="closeModal()">Close</button>
            </div>

            <div class="add-item-controls">
                <b>Add Items to Slip:</b><br><br>
                <select id="itemSelect" style="padding:5px; width: 200px;">
                    <option value="">Select Item...</option>
                </select>
                <input type="number" id="itemQty" placeholder="Qty" style="width:60px; padding:5px;">
                <button onclick="addItemToSlip()" style="padding:5px 10px; cursor:pointer;">Add</button>
            </div>

            <div class="ris-header-top">Appendix 63</div>
            <div class="ris-title">REQUISITION AND ISSUE SLIP</div>

            <div class="ris-info-grid">
                <div style="padding-right: 10px;">
                    <div class="ris-info-row">
                        <span class="ris-label">Entity Name:</span>
                        <span class="ris-input">DepED RO I</span>
                    </div>
                    <div class="ris-info-row">
                        <span class="ris-label">Division:</span>
                        <span class="ris-input">ORD-PUBLIC AFFAIRS UNIT</span>
                    </div>
                    <div class="ris-info-row">
                        <span class="ris-label">Office:</span>
                        <span class="ris-input"></span> </div>
                </div>
                <div>
                    <div class="ris-info-row">
                        <span class="ris-label">Fund Cluster:</span>
                        <span class="ris-input">01</span>
                    </div>
                    <div class="ris-info-row">
                        <span class="ris-label">Responsibility Center Code:</span>
                        <span class="ris-input"></span> </div>
                    <div class="ris-info-row">
                        <span class="ris-label">RIS No.:</span>
                        <span class="ris-input"></span> </div>
                </div>
            </div>

            <table class="ris-table">
                <thead>
                    <tr>
                        <th colspan="4">Requisition</th>
                        <th colspan="2">Stock Available?</th>
                        <th colspan="2">Issue</th>
                    </tr>
                    <tr>
                        <th width="10%">Stock No.</th>
                        <th width="10%">Unit</th>
                        <th width="30%">Description</th>
                        <th width="10%">Quantity</th>
                        <th width="5%">Yes</th>
                        <th width="5%">No</th>
                        <th width="10%">Quantity</th>
                        <th width="20%">Remarks</th>
                    </tr>
                </thead>
                <tbody id="risTableBody">
                    </tbody>
                <tfoot>
                    <tr>
                        <td colspan="8" style="text-align: left; font-weight: bold; border-top: 2px solid black;">Purpose: Office Use</td>
                    </tr>
                </tfoot>
            </table>

            <div class="ris-footer">
                <div class="sig-col">
                    <span class="sig-label">Requested by:</span>
                    <br><br><br>
                    <div class="sig-name">JOVANIE M. MAZON</div>
                    <div class="sig-title">Administrative Assistant I</div>
                    <div class="sig-title">ORD-Public Affairs Unit</div>
                    <div class="sig-date">Date: ________________</div>
                </div>
                <div class="sig-col">
                    <span class="sig-label">Approved by:</span>
                    <br><br><br>
                    <div class="sig-name">CESAR S. BUCSIT</div>
                    <div class="sig-title">Administrative Officer V</div>
                    <div class="sig-title">ORD-Public Affairs Unit Caretaker</div>
                    <div class="sig-date">Date: ________________</div>
                </div>
                <div class="sig-col">
                    <span class="sig-label">Issued by:</span>
                    <br><br><br>
                    <div class="sig-name">&nbsp;</div> <div class="sig-title">&nbsp;</div>
                    <div class="sig-date">Date: ________________</div>
                </div>
                <div class="sig-col">
                    <span class="sig-label">Received by:</span>
                    <br><br><br>
                    <div class="sig-name">&nbsp;</div> <div class="sig-title">&nbsp;</div>
                    <div class="sig-date">Date: ________________</div>
                </div>
            </div>
            </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxPnmXxfno19bkj9VHP1Do97PDg0lp04s",
            authDomain: "supplies-monitoring.firebaseapp.com",
            projectId: "supplies-monitoring",
            storageBucket: "supplies-monitoring.firebasestorage.app",
            messagingSenderId: "524755577094",
            appId: "1:524755577094:web:cd3c45819698c3380a1687",
            measurementId: "G-033SS1BHK1"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let inventoryData = [];
        let slipItems = [];

        window.addEventListener('DOMContentLoaded', () => {
            loadInventory();
            loadStats();
        });

        function nav(id, btn) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- DATABASE LISTENERS ---
        function loadInventory() {
            db.collection('inventory').onSnapshot(snapshot => {
                inventoryData = [];
                let totalStock = 0;
                const tbody = document.getElementById('inventoryTable');
                const select = document.getElementById('itemSelect');
                
                tbody.innerHTML = '';
                select.innerHTML = '<option value="">Select Item...</option>';

                snapshot.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id;
                    inventoryData.push(item);
                    totalStock += item.currentQty;
                });

                // Sort A-Z
                inventoryData.sort((a, b) => a.itemName.localeCompare(b.itemName));

                inventoryData.forEach(item => {
                    let dateDisplay = "-";
                    if (item.requestDates && Array.isArray(item.requestDates)) {
                        dateDisplay = item.requestDates.map(d => new Date(d).toLocaleDateString()).join(', ');
                    }

                    const row = `
                        <tr>
                            <td>${item.itemName}</td>
                            <td>${item.initialQty}</td>
                            <td>${item.unitPrice}</td>
                            <td class="date-cell">${dateDisplay}</td>
                            <td style="font-weight:bold; color:${item.currentQty < 10 ? 'red' : 'green'}">${item.currentQty}</td>
                        </tr>`;
                    tbody.innerHTML += row;

                    const option = document.createElement('option');
                    option.value = item.id;
                    option.text = `${item.itemName} (Stock: ${item.currentQty})`;
                    select.appendChild(option);
                });

                document.getElementById('dash-total-items').innerText = totalStock;
                updateChart();
            });
        }

        function loadStats() {
            db.collection('requisitions').onSnapshot(snap => {
                document.getElementById('dash-total-reqs').innerText = snap.size;
            });
        }

        let stockChart;
        function updateChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const chartData = inventoryData.slice(0, 15); 
            const labels = chartData.map(i => i.itemName);
            const data = chartData.map(i => i.currentQty);

            if(stockChart) stockChart.destroy();

            stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Current Stock Level',
                        data: data,
                        backgroundColor: '#3498db'
                    }]
                }
            });
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);
                
                const batch = db.batch();
                let hasData = false;
                
                json.forEach(row => {
                    const name = row.Name || row.name || row.NAME;
                    const qty = row.Qty || row.qty || row.QTY || row.Quantity;
                    const price = row.Price || row.price || row.PRICE || 0;

                    if(name && qty) {
                        hasData = true;
                        const docRef = db.collection('inventory').doc();
                        batch.set(docRef, {
                            itemName: String(name),
                            initialQty: Number(qty),
                            currentQty: Number(qty),
                            unitPrice: Number(price),
                            requestDates: []
                        });
                    }
                });
                
                if(hasData) {
                    batch.commit().then(() => alert('Inventory Imported Successfully!'));
                } else {
                    alert('Error: Could not find "Name" or "Qty" columns.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- RIS MODAL LOGIC ---
        function openModal() {
            document.getElementById('reqModal').classList.add('open');
            slipItems = [];
            renderSlipTable();
        }

        function closeModal() {
            document.getElementById('reqModal').classList.remove('open');
        }

        function addItemToSlip() {
            const id = document.getElementById('itemSelect').value;
            const qty = Number(document.getElementById('itemQty').value);
            
            if(!id || qty <= 0) return alert("Please select item and quantity");
            
            const dbItem = inventoryData.find(i => i.id === id);
            
            if(qty > dbItem.currentQty) return alert("Not enough stock!");

            // Add to slip items array
            slipItems.push({ 
                id: id, 
                name: dbItem.itemName, 
                unit: "pc", // Default unit, can be customized
                qty: qty 
            });
            renderSlipTable();
        }

        function renderSlipTable() {
            const tbody = document.getElementById('risTableBody');
            tbody.innerHTML = '';
            
            // Render selected items
            slipItems.forEach((item, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td> <td>${item.unit}</td>
                        <td style="text-align:left;">${item.name}</td>
                        <td>${item.qty}</td>
                        <td></td> <td></td> <td></td> <td></td> </tr>
                `;
            });

            // Fill remaining space with empty rows to look like the full sheet
            const rowsNeeded = 15 - slipItems.length;
            for(let i=0; i<rowsNeeded; i++) {
                tbody.innerHTML += `
                    <tr class="empty-row">
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                `;
            }
        }

        async function submitRequisition() {
            if(slipItems.length === 0) return alert("No items to request");

            const batch = db.batch();
            const today = new Date().toISOString(); 

            const reqRef = db.collection('requisitions').doc();
            batch.set(reqRef, {
                requester: "JOVANIE M. MAZON", // Hardcoded based on form
                date: today,
                items: slipItems
            });

            slipItems.forEach(slipItem => {
                const itemRef = db.collection('inventory').doc(slipItem.id);
                const currentStock = inventoryData.find(i => i.id === slipItem.id).currentQty;
                
                batch.update(itemRef, {
                    currentQty: currentStock - slipItem.qty,
                    requestDates: firebase.firestore.FieldValue.arrayUnion(today)
                });
            });

            try {
                await batch.commit();
                alert("Success! Inventory Updated.");
                closeModal();
            } catch(e) {
                console.error(e);
                alert("Error submitting request.");
            }
        }
    </script>
</body>
</html>
